---
# This task will will check the health of the availability group replicas (needs to be run on active node).
# Target SQLAG.yourdomain.com rather than SQL01.yourdomain.com or SQL02.yourdomain.com

- name: Check to see if Availability Group Replicas are Healthy
  ansible.windows.win_shell: |
    # Import Required Powershell Modules
      Import-Module SqlServer
    
    # Initalise Variables
      $SystemHostname = hostname
      $ErrorActionPreference = 'Stop'
      $AvailabilityGroupDatabases = @()
      $AvailabilityGroupReplicas = @()
    
    # Gather Data
      $AvailabilityGroups = Get-ChildItem "SQLSERVER:\SQL\$SystemHostName\Default\AvailabilityGroups"
      
      foreach ($AvailabilityGroup in $AvailabilityGroups) {
        $AvailabilityGroupDatabases += Get-ChildItem "SQLSERVER:\SQL\$SystemHostName\Default\AvailabilityGroups\$($AvailabilityGroup.name)\AvailabilityDatabases"
      
        foreach ($AvailabilityGroupDatabase in $AvailabilityGroupDatabases) {
          $AvailabilityGroupReplicas += Get-ChildItem "SQLSERVER:\SQL\$SystemHostName\Default\AvailabilityGroups\$($AvailabilityGroup.name)\AvailabilityReplicas"
          }
      }
    
    # Evaluate Health
      # Get replicas with ConnectionState not equal to "Connected"
      $DatabaseReplicasNotConnected = $AvailabilityGroupReplicas | Where-Object { $_.ConnectionState -ne "Connected" }
      
      # Determine if all replicas are connected
      $DatabaseReplicasConnected = $DatabaseReplicasNotConnected -eq $null
      
      # Get replicas with RollupSynchronizationState not equal to "Synchronized"
      $DatabaseReplicasNotSynchronized = $AvailabilityGroupReplicas | Where-Object { $_.RollupSynchronizationState -ne "Synchronized" }
      
      # Determine if all replicas are synchronized
      $DatabaseReplicasSynchronized = $DatabaseReplicasNotSynchronized -eq $null
      
      # Overall health of replicas
      if ($DatabaseReplicasConnected -and $DatabaseReplicasSynchronized) {
        Write-Output $True
      } else {
        Write-Output $AvailabilityGroupReplicas | select Name,Role,ConnectionState,RollupSynchronizationState | fl
      }
  register: sql_replicas_healthy

- name: Fail Ansible Play if SQL Replica Health Check Fails
  fail:
    msg:
    - "SQL Replica Health Check Failed."
    - "{{ sql_replicas_healthy.stdout }}"
  when: sql_replicas_healthy.stdout | trim != "True"